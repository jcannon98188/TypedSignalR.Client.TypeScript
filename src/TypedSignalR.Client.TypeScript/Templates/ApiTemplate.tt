<#@ template language="C#" linePragmas="false" debug="false" hostspecific="false"#>
<#@ assembly name="System.Core" #>
<#@ import namespace="System.Linq" #>
<#@ import namespace="System.Text" #>
<#@ import namespace="System.Collections.Generic" #>
<#@ output extension=".cs" #>
/* THIS (.ts) FILE IS GENERATED BY TypedSignalR.Client.TypeScript */
/* eslint-disable */
/* tslint:disable */
// @ts-nocheck
<#= Header #>
<# if (Options.GenerateRxJSReceiver) { #>
import { Subject as Subject$ } from 'rxjs';
<# } #>


// components

export type Disposable = {
    dispose(): void;
}

export type HubProxyFactory<T> = {
    createHubProxy(connection: HubConnection): T;
}

export type ReceiverRegister<T> = {
    register(connection: HubConnection, receiver: T): Disposable;
}

type ReceiverMethod = {
    methodName: string,
    method: (...args: any[]) => void
}

class ReceiverMethodSubscription implements Disposable {

    public constructor(
        private connection: HubConnection,
        private receiverMethod: ReceiverMethod[]) {
    }

    public readonly dispose = () => {
        for (const it of this.receiverMethod) {
            this.connection.off(it.methodName, it.method);
        }
    }
}

// API

export type HubProxyFactoryProvider = {
<# foreach(var hubType in HubTypes) { #>
    (hubType: "<#= hubType.Name #>"): HubProxyFactory<<#= hubType.Name #>>;
<# } #>
}

export const getHubProxyFactory = ((hubType: string) => {
<# foreach(var hubType in HubTypes) { #>
    if(hubType === "<#= hubType.Name #>") {
        return <#= hubType.Name #>_HubProxyFactory.Instance;
    }
<# } #>
}) as HubProxyFactoryProvider;

export type ReceiverRegisterProvider = {
<# foreach(var receiverType in ReceiverTypes) { #>
    (receiverType: "<#= receiverType.Name #>"): ReceiverRegister<<#= receiverType.Name #>>;
<# } #>
}

export const getReceiverRegister = ((receiverType: string) => {
<# foreach(var receiverType in ReceiverTypes) { #>
    if(receiverType === "<#= receiverType.Name #>") {
        return <#= receiverType.Name #>_Binder.Instance;
    }
<# } #>
}) as ReceiverRegisterProvider;

// HubProxy

<# foreach(var hubType in HubTypes) { #>
class <#= hubType.Name #>_HubProxyFactory implements HubProxyFactory<<#= hubType.Name #>> {
    public static Instance = new <#= hubType.Name #>_HubProxyFactory();

    private constructor() {
    }

    public readonly createHubProxy = (connection: HubConnection): <#= hubType.Name #> => {
        return new <#= hubType.Name #>_HubProxy(connection);
    }
}

class <#= hubType.Name #>_HubProxy implements <#= hubType.Name #> {

    public constructor(private connection: HubConnection) {
    }
<# foreach(var method in hubType.Methods) { #>
<#= method.CreateMethodString(SpecialSymbols, Options) #>
<# } #>
}

<# } #>

// Receiver

<# foreach(var receiverType in ReceiverTypes) { #>
class <#= receiverType.Name #>_Binder implements ReceiverRegister<<#= receiverType.Name #>> {

    public static Instance = new <#= receiverType.Name #>_Binder();

    private constructor() {
    }

    public readonly register = (connection: HubConnection, receiver: <#= receiverType.Name #>): Disposable => {

<# foreach(var method in receiverType.Methods) { #>
        const __<#= method.Name.Format(Options.NamingStyle) #> = <#= method.TranslateReceiverMethodIntoLambdaExpressionSyntax(SpecialSymbols, Options) #>;
<# } #>

<# foreach(var method in receiverType.Methods) { #>
        connection.on("<#= method.Name #>", __<#= method.Name.Format(Options.NamingStyle) #>);
<# } #>

        const methodList: ReceiverMethod[] = [
<# for(int i = 0; i < receiverType.Methods.Count; i++) { #>
            { methodName: "<#= receiverType.Methods[i].Name #>", method: __<#= receiverType.Methods[i].Name.Format(Options.NamingStyle) #> }<#= i != receiverType.Methods.Count - 1 ? "," : "" #>
<# } #>
        ]

        return new ReceiverMethodSubscription(connection, methodList);
    }
}

<# } #>

<# if(Options.GenerateRxJSReceiver) { #>
<# foreach(var receiverType in ReceiverTypes) { #>
export const <#= receiverType.FormatInterfaceNameAsConcrete() #> = (connection: HubConnection) => {
    <# foreach(var method in receiverType.Methods) { #>
const __<#= method.Name.Format(Options.NamingStyle) #>$ = <#= method.TranslateReceiverMethodIntoRxJSSubjectSyntax(SpecialSymbols, Options) #>;
    connection.on("<#= method.Name #>", <#= method.TranslateReceiverMethodIntoRxJSConnectionNextSyntax(SpecialSymbols, Options) #>);
    <# } #>

    return {
    <# foreach(var method in receiverType.Methods) { #>
    <#= method.Name.Format(Options.NamingStyle) #>$: __<#= method.Name.Format(Options.NamingStyle) #>$.asObservable(),
    <# } #>
}
} 
<# } #>
<# } #>
